<!DOCTYPE html>
<html>
    <head>
        <title>Custom Elements</title>
    </head>
    <body>
        <div>Progress Bar</div>
        <progress-bar width="400px" progress="15%"></progress-bar>
        <script>console.clear()</script>
        <template id="progress-bar-template">
            <style>
                div {
                    display: inline-block;
                    height: 20px;
                }
                div:has(div) {
                    background: #d8d8d8;
                    overflow: hidden;
                }
                div > div {
                    background: #77f;
                }
            </style>
            <div><div></div></div>
        </template>
        <script>
            customElements.define('progress-bar', class extends HTMLElement {

                static observedAttributes = ['width', 'progress'];

                constructor() {
                    super()
                }
                
                get width() {
                    return this.getAttribute('width')
                }
                
                get progress() {
                    const progress = this.getAttribute('progress')
                    if (!progress.endsWith('%')) return progress
                    const scrollWidth = this.shadowRoot.querySelectorAll('div:has(div)')[0].scrollWidth
                    return scrollWidth * parseFloat(progress) / 100
                }
                
                connectedCallback() {
                    console.log(this)
                    const elt = document.getElementById("progress-bar-template").content.cloneNode(true)
                    this.attachShadow({mode: 'open'}).appendChild(elt)
                    this.shadowRoot.querySelectorAll('div:has(div)').forEach(div => div.style = `width: ${this.width};`)
                    this.shadowRoot.querySelectorAll('div > div').forEach(div => div.style = `width: ${this.progress}px;`)
                }
                
                disconnectedCallback() {
                }
                
                attributeChangedCallback(attrName, oldVal, newVal) {
                    if (!this.shadowRoot) return
                    this.shadowRoot.querySelectorAll('div:has(div)').forEach(div => div.style = `width: ${this.width};`)
                    this.shadowRoot.querySelectorAll('div > div').forEach(div => div.style = `width: ${this.progress}px;`)
                }
            })
            
            let progress = 0
            const tick = () => {
                if (progress > 110) progress = -100
                document.querySelectorAll('progress-bar').forEach(div => div.setAttribute('progress', progress + '%'))
                progress += 1
            }
            setInterval(tick, 10)
        </script>
    </body>
</html>
