<!DOCTYPE html>
<html>
    <head>
        <title>WebRTC Screen Share Demo</title>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <pre id="console_say_output" style="position: fixed; bottom: 10px; left: 10px; right: 10px; border: thin solid gray; overflow: hidden; padding: 4px; background: #0001"></pre>
        <script src="jquery.js"></script>
        <script src="https://unpkg.com/@timkay/say@0.2.0/index.js"></script>
        <script src="weedit.js" defer></script>
        <h1>WebRTC Screen Share Demo</h1>
        <script type="module">
            console.clear()

            // See https://developer.mozilla.org/en-US/docs/Web/API/EventTarget
            const presenter = EventTarget()
            const viewer = EventTarget()

            // See
            //  https://developer.mozilla.org/en-US/docs/Web/API/MediaStream
            //  https://webrtc.org/getting-started/peer-connections
            //  https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling
            // See https://developer.mozilla.org/en-US/docs/Web/API/Screen_Capture_API/Using_Screen_Capture

            const configuration = {
                iceServers: [
                    {
                        urls: "stun:stun.relay.metered.ca:80",
                    },
                    {
                        urls: "turn:standard.relay.metered.ca:80",
                        username: "9e26e285d01d6f8a3010fb43",
                        credential: "eW+Oibgy68A85uBJ",
                    },
                    {
                        urls: "turn:standard.relay.metered.ca:80?transport=tcp",
                        username: "9e26e285d01d6f8a3010fb43",
                        credential: "eW+Oibgy68A85uBJ",
                    },
                    {
                        urls: "turn:standard.relay.metered.ca:443",
                        username: "9e26e285d01d6f8a3010fb43",
                        credential: "eW+Oibgy68A85uBJ",
                    },
                    {
                        urls: "turn:standard.relay.metered.ca:443?transport=tcp",
                        username: "9e26e285d01d6f8a3010fb43",
                        credential: "eW+Oibgy68A85uBJ",
                    },
                ],
            }

            async function makeCall(track) {
                const peer = new RTCPeerConnection()
                $(peer).on('addstream connectionstatechange datachannel icecandidate icecandidateerror iceconnectionstatechange iceconnectiongatheringchange negotiationneeded removestream signalingstatechange track', async event => {
                    event = event.originalEvent
                    say `event ${event.type} ${peer.connectionState} ${peer.signalingState}`
                    if (event.type === 'icecandidate') {
                        say `  ${event.candidate}`
                    }
                })
                peer.addEventListener('negotiationneeded', async event => {
                    const offer = await peer.createOffer()
                    await peer.setLocalDescription(offer).catch(() => say `set failure`)
                    say `${offer.toJSON()}`
                    const copy = $('<button>Copy</button>').appendTo('body').one('click', event => {
                        copy.remove()
                        const type = 'text/plain'
                        const blob = new Blob([JSON.stringify(offer.toJSON())], {type})
                        const data = [new ClipboardItem({[type]: blob})]
                        navigator.clipboard.write(data).catch(() => say `copy failure`)
    
                        $('<textarea rows="10" cols="70"></textarea').appendTo('body').one('change', async event => {
                            const target = $(event.target)
                            const answer = target.val()
                            target.remove()
                            say `${answer}`
                            await peer.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)))
                        })
                    })
                })
                peer.addEventListener('signalingstatechange', async event => {
                    if (peer.signalingState === 'stable') {
                        for (const ice of ices) {
                            await peer.addIceCandidate(ice)
                        }
                    }
                })
                const sender = peer.addTrack(track)
            }

            async function answerCall(offer) {
                const peer = new RTCPeerConnection()
                $(peer).on('addstream connectionstatechange datachannel icecandidate icecandidateerror iceconnectionstatechange iceconnectiongatheringchange negotiationneeded removestream signalingstatechange track', async event => {
                    event = event.originalEvent
                    say `event ${event.type} ${peer.connectionState} ${peer.signalingState}`
                    if (event.type === 'icecandidate') {
                        say `  ${event.candidate}`
                    }
                })
                await peer.setRemoteDescription(new RTCSessionDescription(offer))
                const answer = await peer.createAnswer()
                await peer.setLocalDescription(answer)
                say `${answer.toJSON()}`
                const copy = $('<button>Copy</button>').appendTo('body').one('click', event => {
                    copy.remove()
                    const type = 'text/plain'
                    const blob = new Blob([JSON.stringify(answer.toJSON())], {type})
                    const data = [new ClipboardItem({[type]: blob})]
                    navigator.clipboard.write(data).catch(() => say `copy failure`)
                })
            }

            async function main() {
                await navigator.mediaDevices.getDisplayMedia({video: {displaySurface: 'monitor', cursor: 'always' /* motion or never */}, audio: false})
                .then(mediaStream => {
                    say `mediaStream active ${mediaStream.active}`
                    const tracks = mediaStream.getTracks()
                    say `tracks ${tracks.length} tracks: ${tracks.map(track => track.kind)} remote: ${tracks.map(track => track.remote)}`
                    const track = tracks[0]
                    $(track).on('ended', event => {
                        event = event.originalEvent
                        say `event ${event.type}`
                    })
                    makeCall(track)
                })
                .catch(() => {
                    say `mediaStream cancelled`
                })
            }

            const share = $('<button>Share</button>').appendTo('body')
            const view = $('<button>View</button>').appendTo('body')

            // See https://stackoverflow.com/a/9851769
            const isFirefox = typeof InstallTrigger !== 'undefined'
            if (true || isFirefox) {
                share.one('click', () => {
                    share.remove()
                    view.remove()
                    main()
                })
            } else {
                main()
            }

            view.one('click', () => {
                share.remove()
                view.remove()
                $('<textarea rows="10" cols="70"></textarea').appendTo('body').one('change', event => {
                    const target = $(event.target)
                    const offer = target.val()
                    target.remove()
                    say `${offer}`
                    answerCall(JSON.parse(offer))
                })
            })

        </script>
    </body>
</html>
